name: Record m3u8 → Internet Archive

on:
  workflow_dispatch:
    inputs:
      m3u8_url:
        description: 'رابط m3u8'
        required: true
      duration_minutes:
        description: 'مدة التسجيل بالدقايق (5–360 دقيقة)'
        required: true
        default: '10'
      title:
        description: 'عنوان التسجيل (اختياري)'
        required: false
        default: 'تسجيل بث مباشر'

jobs:
  record-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: تثبيت الأدوات اللازمة
        run: |
          sudo apt update && sudo apt install -y ffmpeg
          pip install internetarchive

      - name: تسجيل البث
        run: |
          MINUTES="${{ inputs.duration_minutes }}"
          if ! [[ "\( MINUTES" =~ ^[0-9]+ \) ]] || [ "$MINUTES" -lt 5 ] || [ "$MINUTES" -gt 360 ]; then
            echo "خطأ: المدة يجب أن تكون رقم بين 5 و 360"
            exit 1
          fi
          DURATION_SECONDS=$(( MINUTES * 60 ))

          OUTPUT="record_$(date +%Y%m%d_%H%M%S).ts"
          LOGFILE="ffmpeg.log"

          # ──────────────────────────────────────────────────────────────
          # Headers لتجنب 406: User-Agent حديث + Accept مناسب لـ HLS/m3u8
          # إذا عرفت موقع البث/الـ player، ضع REFERER هنا (مثال: https://example.com/player)
          # ──────────────────────────────────────────────────────────────
          UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/132.0.0.0 Safari/537.36"
          REFERER=""  # ← غيّر إذا لزم الأمر، مثال: "https://www.souq-live.com/player"

          HEADERS="User-Agent: ${UA}\r\nAccept: application/vnd.apple.mpegurl,application/x-mpegURL,video/MP2T,*/*\r\nAccept-Language: en-US,en;q=0.9,ar;q=0.8\r\n"
          [ -n "\( REFERER" ] && HEADERS=" \){HEADERS}Referer: ${REFERER}\r\n"

          echo "جاري التسجيل لمدة ${MINUTES} دقيقة..."
          echo "الملف الناتج: ${OUTPUT}"
          echo "Headers المرسلة: ${HEADERS}"

          # محاولات متعددة (للتعامل مع توكنات مؤقتة أو انقطاع مؤقت)
          SUCCESS=false
          for attempt in {1..3}; do
            echo "محاولة ${attempt}/3..."

            timeout 60s ffmpeg -headers "${HEADERS}" \
              -i "${{ inputs.m3u8_url }}" \
              -t "$DURATION_SECONDS" \
              -c copy \
              -bsf:a aac_adtstoasc \
              -y "$OUTPUT" 2>"$LOGFILE" || true

            if [ -s "$OUTPUT" ] && [ $(stat -c%s "$OUTPUT") -gt 1048576 ]; then  # > 1MB
              echo "نجاح! الملف صالح."
              SUCCESS=true
              break
            else
              echo "فشل المحاولة ${attempt} (حجم صغير أو فارغ)"
              cat "$LOGFILE"
              rm -f "$OUTPUT" >/dev/null 2>&1
              sleep 10
            fi
          done

          if [ "$SUCCESS" != "true" ]; then
            echo "فشل التسجيل بعد 3 محاولات"
            echo "=== آخر log من ffmpeg ==="
            cat "$LOGFILE"
            exit 1
          fi

          echo "output_file=$OUTPUT" >> $GITHUB_ENV
          echo "size_mb=$(du -m "$OUTPUT" | cut -f1)" >> $GITHUB_ENV

      - name: رفع إلى Internet Archive
        env:
          S3_ACCESS_KEY: ${{ secrets.S3_ACCESS_KEY }}
          S3_SECRET_KEY: ${{ secrets.S3_SECRET_KEY }}
        run: |
          python - <<EOF
          from internetarchive import upload
          import os
          from datetime import date

          identifier = "record-\( (date +%Y%m%d-%H%M%S)- \){GITHUB_RUN_ID}"
          file_path = "${{ env.output_file }}"

          title = "${{ inputs.title }}" or "تسجيل m3u8 تلقائي - $(date +%Y-%m-%d)"

          metadata = {
              'title': title,
              'description': f'تسجيل مدة ${{ inputs.duration_minutes }} دقيقة من بث m3u8',
              'mediatype': 'movies',
              'collection': 'opensource_movies',
              'subject': 'livestream;m3u8;recording'
          }

          print(f"جاري الرفع بمعرف: {identifier}")

          r = upload(identifier, files=[file_path], metadata=metadata, access_key=os.environ['S3_ACCESS_KEY'], secret_key=os.environ['S3_SECRET_KEY'])

          if r[0].status_code == 200:
              print("تم الرفع بنجاح!")
          else:
              print("فشل الرفع:", r[0].status_code, r[0].text)

          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"identifier={identifier}\n")
          EOF

      - name: عرض النتيجة النهائية
        if: always()
        run: |
          echo ""
          echo "══════════════════════════════════════════════════════"
          echo "الحجم          : ${{ env.size_mb }} MB"
          echo "المدة          : ${{ inputs.duration_minutes }} دقيقة"
          echo "المعرف         : ${{ env.identifier }}"
          echo "رابط العرض     : https://archive.org/details/${{ env.identifier }}"
          echo "رابط التحميل   : https://archive.org/download/\( {{ env.identifier }}/ \){{ env.output_file }}"
          echo "══════════════════════════════════════════════════════"
          echo ""
          echo "ملاحظة: التسجيلات الطويلة قد تحتاج وقتاً للمعالجة على archive.org (10–60 دقيقة)"
          echo "إذا استمر الخطأ 406، جرب إضافة Referer صحيح أو شغل محلياً بدلاً من GitHub."