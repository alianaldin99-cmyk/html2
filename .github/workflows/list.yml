name: Record m3u8 → Internet Archive (كـ Playlist واحدة)

on:
  workflow_dispatch:
    inputs:
      m3u8_url:
        description: 'رابط m3u8'
        required: true
      duration_minutes:
        description: 'مدة التسجيل بالدقايق (5–360 دقيقة)'
        required: true
        default: '10'
      title:
        description: 'عنوان التسجيل (يظهر في قائمة الملفات داخل الصفحة)'
        required: false
        default: 'تسجيل بث مباشر'

jobs:
  record-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 400
    steps:
      - name: تثبيت الأدوات اللازمة
        run: |
          sudo apt update && sudo apt install -y ffmpeg
          pip install --upgrade internetarchive

      - name: تسجيل البث باستخدام ffmpeg
        run: |
          MINUTES="${{ inputs.duration_minutes }}"
          DURATION_SECONDS=$(( MINUTES * 60 ))

          OUTPUT_FILE="record_$(date +%Y%m%d_%H%M%S).ts"

          ffmpeg -i "${{ inputs.m3u8_url }}" \
            -t "$DURATION_SECONDS" \
            -c copy \
            -y "$OUTPUT_FILE" 2> ffmpeg.log || true

          if [ ! -s "$OUTPUT_FILE" ]; then
            echo "خطأ: فشل التسجيل - الملف فارغ"
            cat ffmpeg.log
            exit 1
          fi

          echo "output_file=$OUTPUT_FILE" >> $GITHUB_ENV
          echo "size_mb=$(du -m "$OUTPUT_FILE" | cut -f1)" >> $GITHUB_ENV

      - name: رفع الملف إلى Internet Archive (نفس الصفحة / Playlist)
        env:
          IA_ACCESS_KEY: ${{ secrets.S3_ACCESS_KEY }}
          IA_SECRET_KEY: ${{ secrets.S3_SECRET_KEY }}
        run: |
          python3 - <<'EOF'
          from internetarchive import upload
          import os
          from datetime import datetime

          # ← غيّر هذا الاسم ليكون ثابت وخاص بيك (حروف صغيرة، - أو _ فقط، بدون مسافات)
          FIXED_IDENTIFIER = "m3u8-tasjilat-mohamed-2026"

          file_path = os.environ.get('output_file', 'record_error.ts')

          # عنوان الملف داخل الصفحة (يظهر في قائمة التشغيل)
          file_title = "${{ inputs.title }}" or f"تسجيل {datetime.now().strftime('%Y-%m-%d %H:%M')} – ${{ inputs.duration_minutes }} د"

          # Metadata عامة للـ item (تُطبق مرة واحدة فقط في أول رفع)
          metadata = {
              'title': 'مجموعة تسجيلات بث مباشر m3u8 – Playlist واحدة',
              'description': 'تسجيلات متعددة من روابط m3u8 – يتم إضافتها تدريجياً إلى نفس الصفحة كقائمة تشغيل داخلية على archive.org',
              'mediatype': 'movies',
              'collection': 'opensource_movies',
              'subject': ['livestream', 'm3u8', 'recording', 'playlist', 'archive'],
              'creator': 'Mohamed - تسجيلات مباشرة',
              'licenseurl': 'https://creativecommons.org/licenses/by-nc-sa/4.0/'
          }

          print(f"جاري الرفع إلى الصفحة الثابتة → {FIXED_IDENTIFIER}")
          print(f"اسم الملف داخل القائمة: {file_title}")

          try:
              responses = upload(
                  FIXED_IDENTIFIER,
                  files=[{'name': file_path, 'title': file_title}],
                  metadata=metadata,
                  access_key=os.environ['IA_ACCESS_KEY'],
                  secret_key=os.environ['IA_SECRET_KEY'],
                  verbose=True,
                  retries=5,
                  retries_sleep=10
              )

              success = all(r.status_code in (200, 201) for r in responses)
              if success:
                  print("تم الرفع بنجاح! الملف أُضيف إلى الـ playlist ✓")
              else:
                  print("فشل الرفع:")
                  for r in responses:
                      print(f"  → {r.status_code}: {r.text.strip()}")
          except Exception as e:
              print(f"خطأ أثناء الرفع: {str(e)}")
              raise

          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"identifier={FIXED_IDENTIFIER}\n")
          EOF

      - name: عرض النتيجة النهائية
        if: always()
        run: |
          echo ""
          echo "═══════════════════════════════════════════════════════════════"
          echo "الحجم               : ${{ env.size_mb }} MB"
          echo "المدة               : ${{ inputs.duration_minutes }} دقيقة"
          echo "الصفحة الثابتة (Playlist) : https://archive.org/details/${{ env.identifier }}"
          echo "رابط التحميل المباشر     : https://archive.org/download/\( {{ env.identifier }}/ \){{ env.output_file }}"
          echo ""
          echo "→ انتظر 10–60 دقيقة بعد الرفع عشان الـ player يحدث ويظهر الملف الجديد في القائمة."
          echo "  افتح الرابط الأول → شغّل الـ player → هتلاقي قائمة بالتسجيلات تحت الفيديو."
          echo "═══════════════════════════════════════════════════════════════"
          echo ""
          echo "ملاحظة: كل تشغيل جديد للـ workflow هيضيف ملف جديد لنفس الصفحة بدون إنشاء صفحات منفصلة."