name: Record m3u8 → Internet Archive (Playlist Mode)

on:
  workflow_dispatch:
    inputs:
      m3u8_url:
        description: 'رابط m3u8'
        required: true
      duration_minutes:
        description: 'مدة التسجيل بالدقايق (5–360 دقيقة)'
        required: true
        default: '10'
      title:
        description: 'عنوان التسجيل (اختياري)'
        required: false
        default: 'تسجيل بث مباشر'
      playlist_identifier:          # ← الجديد
        description: 'اسم الـ playlist / identifier (مثال: my-tv-channel-recordings)'
        required: true
        default: 'my-livestream-recordings'

jobs:
  record-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: تثبيت الأدوات
        run: |
          sudo apt update && sudo apt install -y ffmpeg
          pip install internetarchive

      - name: تسجيل البث
        run: |
          MINUTES="${{ inputs.duration_minutes }}"
          DURATION_SECONDS=$(( MINUTES * 60 ))

          # نستخدم اسم ملف واضح يبين التاريخ والمدة
          OUTPUT="record_\( (date +%Y%m%d_%H%M%S)_ \){MINUTES}min.ts"

          ffmpeg -i "${{ inputs.m3u8_url }}" \
            -t "$DURATION_SECONDS" \
            -c copy \
            -y "$OUTPUT" 2> ffmpeg.log || true

          if [ ! -s "$OUTPUT" ]; then
            echo "فشل التسجيل (حجم الملف صفر)"
            cat ffmpeg.log
            exit 1
          fi

          echo "output_file=$OUTPUT" >> $GITHUB_ENV
          echo "size_mb=$(du -m "$OUTPUT" | cut -f1)" >> $GITHUB_ENV

      - name: رفع إلى Internet Archive (نفس الـ identifier)
        env:
          S3_ACCESS_KEY: ${{ secrets.S3_ACCESS_KEY }}
          S3_SECRET_KEY: ${{ secrets.S3_SECRET_KEY }}
        run: |
          python - <<EOF
          from internetarchive import upload, get_item
          import os
          from datetime import datetime

          identifier = "${{ inputs.playlist_identifier }}"

          file_path = "${{ env.output_file }}"

          # عنوان الفيديو الواحد (هيظهر في الـ playlist)
          segment_title = "\( {{ inputs.title }}" or f"تسجيل {datetime.now().strftime('%Y-%m-%d %H:%M')} – \){{ inputs.duration_minutes }} دقيقة"

          metadata = {
              'title': segment_title,           # عنوان الـ segment الواحد
              'description': f'تسجيل مدة ${{ inputs.duration_minutes }} دقيقة من بث m3u8\\nPlaylist: {identifier}',
              'mediatype': 'movies',
              'collection': 'opensource_movies',
              'subject': 'livestream;m3u8;recording;playlist',
              # لو عايز تضيف رقم الحلقة أو ترتيب → ممكن تضيف custom field
          }

          print(f"جاري الرفع إلى الـ identifier الموجود: {identifier}")

          # نرفع الملف الجديد لنفس الـ item
          r = upload(identifier, files=[file_path], metadata=metadata,
                     access_key=os.environ['S3_ACCESS_KEY'],
                     secret_key=os.environ['S3_SECRET_KEY'],
                     verbose=True)

          if r[0].status_code in [200, 201]:
              print("تم الرفع بنجاح → سيظهر في الـ playlist بعد derive")
          else:
              print("فشل الرفع:", r[0].status_code, r[0].text)
              exit(1)

          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"identifier={identifier}\\n")
          EOF

      - name: عرض النتيجة النهائية
        if: always()
        run: |
          echo ""
          echo "══════════════════════════════════════════════════════"
          echo "الحجم          : ${{ env.size_mb }} MB"
          echo "المدة          : ${{ inputs.duration_minutes }} دقيقة"
          echo "اسم الـ Playlist : ${{ inputs.playlist_identifier }}"
          echo "رابط الصفحة     : https://archive.org/details/${{ env.identifier }}"
          echo "رابط التحميل    : https://archive.org/download/\( {{ env.identifier }}/ \){{ env.output_file }}"
          echo "══════════════════════════════════════════════════════"
          echo ""
          echo "ملاحظة مهمة:"
          echo "• كل تسجيل جديد هيتضاف كملف منفصل في نفس الصفحة"
          echo "• انتظر 10–60 دقيقة بعد الرفع عشان الـ derive يخلّص والـ playlist تظهر كاملة"
          echo "• لو عايز تغيّر ترتيب الملفات أو العناوين → ادخل على الصفحة وعدّل يدوي"