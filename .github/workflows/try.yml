name: Record IPTV m3u8 → Internet Archive (بـ VLC)

on:
  workflow_dispatch:
    inputs:
      m3u8_url:
        description: 'رابط m3u8 أو get.php الكامل'
        required: true
      duration_minutes:
        description: 'مدة التسجيل بالدقايق (5–360 دقيقة)'
        required: true
        default: '10'
      title:
        description: 'عنوان التسجيل (يظهر في قائمة الملفات)'
        required: false
        default: 'تسجيل بث IPTV'

jobs:
  record-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 400
    steps:
      - name: تثبيت VLC و الأدوات اللازمة
        run: |
          sudo apt update
          sudo apt install -y vlc ffmpeg  # ffmpeg احتياطي لو احتجناه لاحقاً
          pip install --upgrade internetarchive

      - name: تسجيل البث بـ cvlc (VLC command-line)
        run: |
          MINUTES="${{ inputs.duration_minutes }}"
          DURATION_SECONDS=$(( MINUTES * 60 ))

          OUTPUT="record_$(date +%Y%m%d_%H%M%S).ts"

          # استخدام cvlc للتسجيل مع headers لتجنب 406 أو 403
          cvlc \
            --http-user-agent="Mozilla/5.0 (Linux; Android 14; Pixel 8) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Mobile Safari/537.36" \
            --http-referrer="http://24.mhpro1.xyz/" \
            "${{ inputs.m3u8_url }}" \
            --sout="#std{access=file,mux=ts,dst=$OUTPUT}" \
            --run-time=$DURATION_SECONDS \
            --stop-time=$DURATION_SECONDS \
            --no-video \
            --no-audio-display \
            --quiet \
            vlc://quit 2> vlc.log || true

          if [ ! -s "$OUTPUT" ]; then
            echo "فشل التسجيل - الملف فارغ أو حجم صفر"
            echo "الخطأ من cvlc:"
            cat vlc.log
            exit 1
          fi

          echo "output_file=$OUTPUT" >> $GITHUB_ENV
          echo "size_mb=$(du -m "$OUTPUT" | cut -f1)" >> $GITHUB_ENV

      - name: رفع إلى Internet Archive (نفس الصفحة / Playlist)
        env:
          IA_ACCESS_KEY: ${{ secrets.S3_ACCESS_KEY }}
          IA_SECRET_KEY: ${{ secrets.S3_SECRET_KEY }}
        run: |
          python3 - <<'EOF'
          from internetarchive import upload
          import os
          from datetime import datetime

          FIXED_IDENTIFIER = "m3u8-tasjilat-mohamed-2026"  # غيّره لو عايز اسم مختلف

          file_path = os.environ.get('output_file', 'record_error.ts')

          file_title = "${{ inputs.title }}" or f"تسجيل {datetime.now().strftime('%Y-%m-%d %H:%M')} – ${{ inputs.duration_minutes }} د"

          metadata = {
              'title': 'مجموعة تسجيلات IPTV – Playlist واحدة',
              'description': 'تسجيلات من روابط IPTV/Xtream Codes باستخدام VLC',
              'mediatype': 'movies',
              'collection': 'opensource_movies',
              'subject': ['iptv', 'm3u8', 'xtream', 'livestream', 'recording'],
              'creator': 'Mohamed - تسجيلات مباشرة'
          }

          print(f"جاري الرفع إلى: {FIXED_IDENTIFIER}")

          try:
              responses = upload(
                  FIXED_IDENTIFIER,
                  files=[{'name': file_path, 'title': file_title}],
                  metadata=metadata,
                  access_key=os.environ['IA_ACCESS_KEY'],
                  secret_key=os.environ['IA_SECRET_KEY'],
                  verbose=True,
                  retries=5
              )
              success = all(r.status_code in (200, 201) for r in responses)
              if success:
                  print("تم الرفع بنجاح!")
              else:
                  print("فشل الرفع:")
                  for r in responses:
                      print(f"  → {r.status_code}: {r.text.strip()}")
          except Exception as e:
              print(f"خطأ: {str(e)}")
              raise

          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"identifier={FIXED_IDENTIFIER}\n")
          EOF

      - name: عرض النتيجة
        if: always()
        run: |
          echo ""
          echo "═══════════════════════════════════════════════════════════════"
          echo "الحجم               : ${{ env.size_mb }} MB"
          echo "المدة               : ${{ inputs.duration_minutes }} دقيقة"
          echo "الصفحة              : https://archive.org/details/${{ env.identifier }}"
          echo "رابط التحميل       : https://archive.org/download/\( {{ env.identifier }}/ \){{ env.output_file }}"
          echo ""
          echo "→ انتظر 10–60 دقيقة بعد الرفع عشان يظهر في الـ player."
          echo "═══════════════════════════════════════════════════════════════"
          echo ""
          if [ -f vlc.log ]; then
            echo "آخر جزء من vlc.log (للتشخيص):"
            tail -n 20 vlc.log
          fi