name: Record m3u8 â†’ Internet Archive (Headers Fix)

on:
  workflow_dispatch:
    inputs:
      m3u8_url:
        description: 'Ø±Ø§Ø¨Ø· m3u8'
        required: true
        type: string
      duration_minutes:
        description: 'Ù…Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ (5â€“180 Ø¯Ù‚ÙŠÙ‚Ø©)'
        required: true
        type: number
        default: 10
      title:
        description: 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)'
        required: false
        type: string
        default: 'ØªØ³Ø¬ÙŠÙ„ Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±'

jobs:
  record-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: ØªØ«Ø¨ÙŠØª Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù„Ø§Ø²Ù…Ø©
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg curl jq
          pip install internetarchive

      - name: ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø« Ù…Ø¹ Ù‡ÙŠØ¯Ø±Ø² Ù‚ÙˆÙŠØ©
        run: |
          # Ø­Ø³Ø§Ø¨ Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ ØµØ­ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ø®Ø·Ø£ syntax
          MINUTES="${{ inputs.duration_minutes }}"
          DURATION_SECONDS=$(( MINUTES * 60 ))

          OUTPUT="record_$(date +%Y%m%d_%H%M%S).ts"

          HEADERS="User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36"$'\r\n'\
"Referer: https://thksmom.shop/"$'\r\n'\
"Origin: https://thksmom.shop"$'\r\n'\
"Accept: */*"$'\r\n'\
"Accept-Language: en-US,en;q=0.9"$'\r\n'\
"Connection: keep-alive"

          echo "Ø¬Ø§Ø±ÙŠ Ù…Øµ Ø§Ù„Ù…ØªØ¹Ø© Ù„Ù€ $MINUTES Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ø¹ Ù‡ÙŠØ¯Ø±Ø² Ø´ÙŠØ·Ø§Ù†ÙŠØ© ğŸ’¦"

          ffmpeg -headers "$HEADERS" \
            -http_persistent 1 \
            -timeout 60000000 \
            -i "${{ inputs.m3u8_url }}" \
            -t "$DURATION_SECONDS" \
            -c copy \
            -y "$OUTPUT" > ffmpeg_out.log 2> ffmpeg_err.log || true

          if [ ! -s "$OUTPUT" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo " ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ - Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            tail -n 30 ffmpeg_err.log
            tail -n 10 ffmpeg_out.log
            exit 1
          fi

          echo "Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù†Ø¬Ø­ âœ“ Ø§Ù„Ø­Ø¬Ù…: $(du -h "$OUTPUT" | cut -f1)"

          echo "output_file=$OUTPUT" >> $GITHUB_ENV
          echo "size_mb=$(du -m "$OUTPUT" | cut -f1)" >> $GITHUB_ENV
          echo "duration_min=${{ inputs.duration_minutes }}" >> $GITHUB_ENV

      - name: Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Internet Archive
        if: success()
        env:
          S3_ACCESS_KEY: ${{ secrets.S3_ACCESS_KEY }}
          S3_SECRET_KEY: ${{ secrets.S3_SECRET_KEY }}
        run: |
          python - <<EOF
          from internetarchive import upload
          import os
          from datetime import datetime

          identifier = "record-$(date +%Y%m%d-%H%M%S)-${GITHUB_RUN_ID}"

          title = "${{ inputs.title }}" if "${{ inputs.title }}" else "ØªØ³Ø¬ÙŠÙ„ Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± - $(date +%Y-%m-%d)"

          metadata = {
              'title': title,
              'description': f'ØªØ³Ø¬ÙŠÙ„ Ù…Ø¯Ø© ${{ inputs.duration_minutes }} Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ø¹ Ù‡ÙŠØ¯Ø±Ø² Ù‚ÙˆÙŠØ©',
              'mediatype': 'movies',
              'collection': 'opensource_movies',
              'subject': 'livestream;m3u8;recording'
          }

          file_path = "${{ env.output_file }}"

          print(f"Ø¨Ø±ÙØ¹ Ø§Ù„Ù…ØªØ¹Ø© Ø¨Ù…Ø¹Ø±Ù: {identifier}")

          r = upload(identifier, files=[file_path], metadata=metadata, retries=10)

          if any(resp.status_code == 200 for resp in r):
              print("Ø±ÙØ¹Øª Ø§Ù„Ù…ØªØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­ ÙŠØ§ ÙˆÙ„Ø¯ÙŠ ğŸ†ğŸ’¦")
          else:
              print("ÙØ´Ù„ Ù…Ø¤Ù‚Øª:", r)

          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"identifier={identifier}\\n")
          EOF

      - name: Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        if: always()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo " Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ÙŠØ§ Ø³ÙŠØ¯ÙŠ"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Ø§Ù„Ø­Ø¬Ù… : ${{ env.size_mb || 'ØºÙŠØ± Ù…ØªÙˆÙØ±' }} MB"
          echo "Ø§Ù„Ù…Ø¯Ø© : ${{ env.duration_min || 'ØºÙŠØ± Ù…ØªÙˆÙØ±' }} Ø¯Ù‚ÙŠÙ‚Ø©"
          echo "Ø§Ù„Ù…Ø¹Ø±Ù : ${{ env.identifier || 'ØºÙŠØ± Ù…ØªÙˆÙØ±' }}"
          echo ""
          echo "Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ø±Ø¶ : https://archive.org/details/${{ env.identifier || 'ØºÙŠØ± Ù…ØªÙˆÙØ±' }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
