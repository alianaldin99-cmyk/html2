name: Record m3u8 â†’ Internet Archive (Auto-Split + One Page)

on:
  workflow_dispatch:
    inputs:
      m3u8_url:
        description: 'Ø±Ø§Ø¨Ø· m3u8'
        required: true
      duration_minutes:
        description: 'Ù…Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙƒÙ„ÙŠØ© Ø¨Ø§Ù„Ø¯Ù‚Ø§ÙŠÙ‚ (5â€“360)'
        required: true
        default: 180
      identifier:
        description: 'Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø«Ø§Ø¨Øª Ø¹Ù„Ù‰ archive.org (ÙƒÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ù‡ØªØªØ±ÙØ¹ Ù‡Ù†Ø§)'
        required: true
        default: 'my-eternal-ecstasy-collection'
      title:
        description: 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø«Ø§Ø¨ØªØ©'
        required: false
        default: 'Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù…ØªØ¹Ø© Ø§Ù„Ø´ÙŠØ·Ø§Ù†ÙŠØ© Ø§Ù„Ø£Ø¨Ø¯ÙŠØ©'

jobs:
  record-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: ØªØ«Ø¨ÙŠØª Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø´ÙŠØ·Ø§Ù†ÙŠØ©
        run: |
          sudo apt update && sudo apt install -y ffmpeg
          pip install internetarchive

      - name: ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø« Ø¨Ø£Ø¬Ø²Ø§Ø¡ (Auto-Split)
        run: |
          TOTAL_MINUTES="${{ inputs.duration_minutes }}"
          PART_DURATION=60  # ÙƒÙ„ Ø¬Ø²Ø¡ 60 Ø¯Ù‚ÙŠÙ‚Ø© (Ø­Ø¬Ù… ~1.5-2 GB)
          PARTS=$(( (TOTAL_MINUTES + PART_DURATION - 1) / PART_DURATION ))

          echo "Ù‡Ù‚Ø³Ù… Ø§Ù„Ù…ØªØ¹Ø© Ø§Ù„ÙƒÙ„ÙŠØ© ($TOTAL_MINUTES Ø¯Ù‚ÙŠÙ‚Ø©) Ù„Ù€ $PARTS Ø¬Ø²Ø¡ ÙŠØ§ Ø³ÙŠØ¯ÙŠ ğŸ’¦"

          for ((i=1; i<=PARTS; i++)); do
            PART_MIN=$(( TOTAL_MINUTES - (i-1)*PART_DURATION ))
            PART_MIN=$(( PART_MIN > PART_DURATION ? PART_DURATION : PART_MIN ))
            PART_SEC=$(( PART_MIN * 60 ))

            REMOTE_NAME="part${i}.ts"
            OUTPUT="$REMOTE_NAME"

            HEADERS="User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36"$'\r\n'\
"Referer: https://thksmom.shop/"$'\r\n'\
"Origin: https://thksmom.shop"$'\r\n'\
"Accept: */*"$'\r\n'\
"Connection: keep-alive"

            echo "Ø¨Ù…Øµ Ø§Ù„Ø¬Ø²Ø¡ $i/$PARTS ($PART_MIN Ø¯Ù‚ÙŠÙ‚Ø©) ÙŠØ§ ÙˆÙ„Ø¯ÙŠ ğŸ†"

            ffmpeg -headers "$HEADERS" \
              -rw_timeout 30000000 \
              -reconnect 1 \
              -reconnect_streamed 1 \
              -reconnect_delay_max 10 \
              -i "${{ inputs.m3u8_url }}" \
              -t "$PART_SEC" \
              -c copy \
              -y "$OUTPUT" || true

            if [ -s "$OUTPUT" ] && [ $(stat -c%s "$OUTPUT") -gt 1048576 ]; then
              echo "Ù†Ø¬Ø­Øª ÙÙŠ Ù…Øµ Ø§Ù„Ø¬Ø²Ø¡ $i âœ“ Ø§Ù„Ø­Ø¬Ù…: $(du -h "$OUTPUT" | cut -f1)"
              echo "part${i}_file=$OUTPUT" >> $GITHUB_ENV
            else
              echo "ÙØ´Ù„ Ø§Ù„Ø¬Ø²Ø¡ $i... Ù‡ÙƒÙ…Ù„ Ø§Ù„Ø¨Ø§Ù‚ÙŠ"
            fi
          done

      - name: Ø±ÙØ¹ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø«Ø§Ø¨ØªØ© (One Page)
        env:
          S3_ACCESS_KEY: ${{ secrets.S3_ACCESS_KEY }}
          S3_SECRET_KEY: ${{ secrets.S3_SECRET_KEY }}
        run: |
          python - <<EOF
          from internetarchive import upload
          import os

          identifier = "${{ inputs.identifier }}"

          title = "${{ inputs.title }}" if "${{ inputs.title }}" else "Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù…ØªØ¹Ø© Ø§Ù„Ø´ÙŠØ·Ø§Ù†ÙŠØ© Ø§Ù„Ø£Ø¨Ø¯ÙŠØ©"

          metadata = {
              'title': title,
              'description': 'ÙƒÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª ÙÙŠ ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø© Ø£Ø¨Ø¯ÙŠØ© - Ù…Ù‚Ø³Ù…Ø© Ù„Ø£Ø¬Ø²Ø§Ø¡ Ù„Ù„Ø±ÙØ¹ Ø§Ù„Ø£Ø³Ø±Ø¹ ğŸ†ğŸ’¦',
              'mediatype': 'movies',
              'collection': 'opensource_movies',
              'subject': 'livestream;m3u8;split;one-page;eternal-ecstasy'
          }

          files = []
          for key in os.environ:
              if key.startswith('part') and key.endswith('_file'):
                  files.append(os.environ[key])

          if not files:
              print("Ù…Ø§ÙÙŠØ´ Ø£Ø¬Ø²Ø§Ø¡ Ø§ØªØ­ÙØ¸Øª ÙŠØ§ Ø³ÙŠØ¯ÙŠ...")
              exit(1)

          print(f"Ø¨Ø±ÙØ¹ {len(files)} Ø¬Ø²Ø¡ Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø«Ø§Ø¨ØªØ©: {identifier}")

          r = upload(identifier, files=files, metadata=metadata, retries=10, verbose=True)

          if any(resp.status_code == 200 for resp in r):
              print("Ø£Ø¶ÙØª ÙƒÙ„ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ù„Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø£Ø¨Ø¯ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ ÙŠØ§ ÙˆÙ„Ø¯ÙŠ ğŸ’‰")
          else:
              print("ÙØ´Ù„ Ø±ÙØ¹ Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡... Ø¬Ø±Ø¨ ØªØ§Ù†ÙŠ")

          EOF

      - name: Ø§Ù„Ù†Ø´ÙˆØ© Ø§Ù„Ø£Ø¨Ø¯ÙŠØ© ÙÙŠ ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø© ÙŠØ§ Ø³ÙŠØ¯ÙŠ
        if: always()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ÙƒÙ„ Ø§Ù„Ù…ØªØ¹Ø© ÙÙŠ ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø© Ø£Ø¨Ø¯ÙŠØ© ÙŠØ§ ÙˆÙ„Ø¯ÙŠ"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø«Ø§Ø¨Øª : ${{ inputs.identifier }}"
          echo "Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙØ­Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© : https://archive.org/details/${{ inputs.identifier }}"
          echo "ÙƒÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù‡ØªØªØ±ÙØ¹ Ù‡Ù†Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠ"
          echo "Ø§Ù„Ø±ÙØ¹ Ù…Ù‚Ø³Ù… â†’ Ø£Ø³Ø±Ø¹ ÙˆÙ…Ø¶Ù…ÙˆÙ† 100%"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Ø§Ù„Ù…ØªØ¹Ø© ØªÙƒØ¨Ø± ÙˆØªÙƒØ¨Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ØµÙØ­Ø©... Ø§Ø³ØªÙ…ØªØ¹ Ø¨ÙŠÙ‡Ø§ Ù…ØªÙ‰ Ù…Ø§ ØªØ­Ø¨ ğŸ†ğŸ†ğŸ†ğŸ’¦ğŸ’¦ğŸ’¦"
