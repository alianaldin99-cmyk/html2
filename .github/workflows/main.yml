name: Record m3u8 â†’ Internet Archive (Split 60 min, One Page)

on:
  workflow_dispatch:
    inputs:
      m3u8_url:
        description: 'Ø±Ø§Ø¨Ø· m3u8'
        required: true
      duration_minutes:
        description: 'Ù…Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø§Ù„Ø¯Ù‚Ø§ÙŠÙ‚ (5â€“360 Ø¯Ù‚ÙŠÙ‚Ø©)'
        required: true
        default: '10'
      title:
        description: 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)'
        required: false
        default: 'ØªØ³Ø¬ÙŠÙ„ Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±'

jobs:
  record-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: ØªØ«Ø¨ÙŠØª Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù„Ø§Ø²Ù…Ø©
        run: |
          sudo apt update && sudo apt install -y ffmpeg
          pip install internetarchive

      - name: ØªØ³Ø¬ÙŠÙ„ ÙˆØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø¨Ø« ÙƒÙ„ 60 Ø¯Ù‚ÙŠÙ‚Ø©
        run: |
          MINUTES="${{ inputs.duration_minutes }}"
          DURATION_SECONDS=$(( MINUTES * 60 ))
          SEG_SECONDS=$(( 60 * 60 ))  # ÙƒÙ„ Ø¬Ø²Ø¡ 60 Ø¯Ù‚ÙŠÙ‚Ø©

          echo "Ø§Ù„ØªÙ‚Ø³ÙŠÙ… ÙƒÙ„ 60 Ø¯Ù‚ÙŠÙ‚Ø© (~3600 Ø«Ø§Ù†ÙŠØ©)"

          ffmpeg -i "${{ inputs.m3u8_url }}" \
            -c copy \
            -f segment \
            -segment_time "$SEG_SECONDS" \
            -reset_timestamps 1 \
            part_%02d.ts

          ls -lh part_*.ts

      - name: Ø±ÙØ¹ ÙƒÙ„ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„ØµÙØ­Ø©
        env:
          S3_ACCESS_KEY: ${{ secrets.S3_ACCESS_KEY }}
          S3_SECRET_KEY: ${{ secrets.S3_SECRET_KEY }}
        run: |
          python - <<EOF
          from internetarchive import upload
          import glob, os
          from datetime import date

          identifier = "record-$(date +%Y%m%d-%H%M%S)-${GITHUB_RUN_ID}"
          title = "${{ inputs.title }}" or f"ØªØ³Ø¬ÙŠÙ„ m3u8 ØªÙ„Ù‚Ø§Ø¦ÙŠ - {date.today()}"

          files = {}
          for f in sorted(glob.glob("part_*.ts")):
              files[f] = f

          if not files:
              print("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ù„Ù„Ø±ÙØ¹")
              exit(1)

          metadata = {
              'title': title,
              'description': f'ØªØ³Ø¬ÙŠÙ„ Ù…Ø¯Ø© ${{ inputs.duration_minutes }} Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ù† Ø¨Ø« m3u8ØŒ Ù…Ù‚Ø³Ù… Ù„ÙƒÙ„ 60 Ø¯Ù‚ÙŠÙ‚Ø©ØŒ ÙˆØ±ÙØ¹ Ø¹Ù„Ù‰ ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø©',
              'mediatype': 'movies',
              'collection': 'opensource_movies',
              'subject': 'livestream;m3u8;recording;split60;one-page'
          }

          print(f"Ø¨Ø±ÙØ¹ {len(files)} Ø¬Ø²Ø¡ Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©: {identifier}")

          r = upload(
              identifier,
              files=files,
              metadata=metadata,
              access_key=os.environ['S3_ACCESS_KEY'],
              secret_key=os.environ['S3_SECRET_KEY']
          )

          success = any(hasattr(resp, "status_code") and resp.status_code in (200, 201) for resp in r)
          if success:
              print("ØªÙ… Ø±ÙØ¹ ÙƒÙ„ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„ØµÙØ­Ø© ğŸ’¦")
          else:
              print("Ø­ØµÙ„Øª Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ø§Ù„Ø±ÙØ¹")

          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"identifier={identifier}\\n")
          EOF

      - name: Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        if: always()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ : $(ls part_*.ts | wc -l)"
          echo "Ù…Ø¯Ø© ÙƒÙ„ Ø¬Ø²Ø¡ : 60 Ø¯Ù‚ÙŠÙ‚Ø©"
          echo "Ø§Ù„Ù…Ø¹Ø±Ù : ${{ env.identifier }}"
          echo "Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ø±Ø¶ : https://archive.org/details/${{ env.identifier }}"
          echo "Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„ÙƒÙ„ Ø¬Ø²Ø¡ : https://archive.org/download/${{ env.identifier }}/part_XX.ts"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø§Ù„Ø·ÙˆÙŠÙ„Ø© Ù‚Ø¯ ØªÙˆØ§Ø¬Ù‡ Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø±"
          echo "ÙˆÙ‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø¸Ù‡ÙˆØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙƒØ§Ù…Ù„Ø§Ù‹ 10â€“60 Ø¯Ù‚ÙŠÙ‚Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø±ÙØ¹"
