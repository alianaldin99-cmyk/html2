name: Record m3u8 → Internet Archive (Copy Only, One Page)

on:
  workflow_dispatch:
    inputs:
      m3u8_url:
        description: 'رابط m3u8'
        required: true
      identifier:
        description: 'المعرف الثابت (صفحة واحدة فقط)'
        required: true
        default: 'my-recording'
      segment_minutes:
        description: 'مدة كل جزء بالدقائق (يفضل 60)'
        required: true
        default: '60'

jobs:
  record-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: تثبيت الأدوات
        run: |
          sudo apt update
          sudo apt install -y ffmpeg python3-pip
          python3 -m pip install internetarchive

      - name: تسجيل وتقسيم (Copy Only)
        run: |
          SEG_MIN="${{ inputs.segment_minutes }}"
          SEG_SEC=$(( SEG_MIN * 60 ))

          echo "التقسيم كل $SEG_MIN دقيقة"

          ffmpeg -y -i "${{ inputs.m3u8_url }}" \
            -c copy \
            -f segment \
            -segment_time "$SEG_SEC" \
            -reset_timestamps 1 \
            part_%02d.ts

          ls -lh part_*.ts

      - name: رفع كل الأجزاء على صفحة واحدة
        env:
          IA_ACCESS_KEY: ${{ secrets.IA_ACCESS_KEY }}
          IA_SECRET_KEY: ${{ secrets.IA_SECRET_KEY }}
        run: |
          python3 - <<EOF
          from internetarchive import upload
          import glob, os

          identifier = "${{ inputs.identifier }}"

          files = {}
          for f in sorted(glob.glob("part_*.ts")):
              files[f] = f

          if not files:
              print("لا توجد ملفات للرفع")
              exit(1)

          metadata = {
              "title": identifier,
              "mediatype": "movies",
              "collection": "opensource_movies",
              "description": "تسجيل مقسم بدون encoding، على صفحة واحدة",
              "subject": "livestream;m3u8;recording;copy_only"
          }

          print(f"رفع {len(files)} جزء على صفحة واحدة: https://archive.org/details/{identifier}")

          upload(
              identifier,
              files=files,
              metadata=metadata,
              access_key=os.environ["IA_ACCESS_KEY"],
              secret_key=os.environ["IA_SECRET_KEY"],
              verbose=True
          )
          EOF

      - name: النتيجة النهائية
        if: always()
        run: |
          echo "════════════════════════════════════"
          echo "تم التسجيل والتقسيم بنجاح"
          echo "مدة كل جزء : ${{ inputs.segment_minutes }} دقيقة"
          echo "الصفحة الواحدة :"
          echo "https://archive.org/details/${{ inputs.identifier }}"
          echo "════════════════════════════════════"
