name: Record m3u8 → Internet Archive

on:
  workflow_dispatch:
    inputs:
      m3u8_url:
        description: 'رابط m3u8'
        required: true
        type: string
      duration_minutes:
        description: 'مدة التسجيل بالدقائق (5–360 دقيقة)'
        required: true
        type: number
        default: 10
      title:
        description: 'عنوان التسجيل (اختياري)'
        required: false
        type: string
        default: 'تسجيل بث مباشر'

jobs:
  record-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: تثبيت الأدوات اللازمة
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg curl jq

      - name: تسجيل البث
        run: |
          # حساب الثواني بشكل آمن وصحيح
          DURATION_SECONDS=\( (( \){{ inputs.duration_minutes }} * 60 ))

          OUTPUT="record_$(date +%Y%m%d_%H%M%S).mp4"

          echo "جاري تسجيل مدة \( DURATION_SECONDS ثانية ( \){{ inputs.duration_minutes }} دقيقة)"
          echo "الملف الناتج: $OUTPUT"

          ffmpeg -i "${{ inputs.m3u8_url }}" \
            -t "$DURATION_SECONDS" \
            -c copy \
            -bsf:a aac_adtstoasc \
            -y "$OUTPUT" 2> ffmpeg.log || true

          if [ ! -s "$OUTPUT" ]; then
            echo "======================================"
            echo "فشل التسجيل - حجم الملف صفر"
            echo "محتوى ffmpeg.log:"
            cat ffmpeg.log
            echo "======================================"
            exit 1
          fi

          echo "التسجيل تم بنجاح"
          echo "output_file=$OUTPUT" >> $GITHUB_ENV
          echo "size_mb=$(du -m "$OUTPUT" | cut -f1)" >> $GITHUB_ENV
          echo "duration_min=${{ inputs.duration_minutes }}" >> $GITHUB_ENV

      - name: رفع الملف إلى Internet Archive
        env:
          IA_ACCESS_KEY: ${{ secrets.IA_ACCESS_KEY }}
          IA_SECRET_KEY: ${{ secrets.IA_SECRET_KEY }}
        run: |
          # تثبيت أداة ia
          curl -sL https://archive.org/install.sh | bash || true

          # إنشاء معرف فريد
          IDENTIFIER="record-\( (date +%Y%m%d-%H%M%S)- \){{ github.run_id }}"

          TITLE="${{ inputs.title }}"
          [ -z "\( TITLE" ] && TITLE="تسجيل m3u8 تلقائي - \)(date +%Y-%m-%d)"

          echo "جاري الرفع إلى Internet Archive..."
          echo "المعرف: $IDENTIFIER"

          ia upload "$IDENTIFIER" \
            "${{ env.output_file }}" \
            --metadata="title=$TITLE" \
            --metadata="description=تسجيل مدة ${{ env.duration_min }} دقيقة من بث m3u8" \
            --metadata="mediatype:movie" \
            --metadata="collection:opensource_movies" \
            --metadata="subject:livestream;m3u8;recording" \
            --retries=3 || true

          echo "identifier=$IDENTIFIER" >> $GITHUB_ENV

      - name: عرض النتيجة النهائية
        if: always()
        run: |
          echo ""
          echo "═══════════════════════════════════════════════════════════"
          echo "              النتيجة النهائية للوظيفة"
          echo "═══════════════════════════════════════════════════════════"
          echo "الحجم           : ${{ env.size_mb || 'غير متوفر' }} MB"
          echo "المدة           : ${{ env.duration_min || 'غير متوفر' }} دقيقة"
          echo "اسم الملف       : ${{ env.output_file || 'غير متوفر' }}"
          echo "المعرف          : ${{ env.identifier || 'غير متوفر' }}"
          echo ""
          echo "رابط صفحة العرض : https://archive.org/details/${{ env.identifier || 'غير متوفر' }}"
          echo "رابط التحميل    : https://archive.org/download/\( {{ env.identifier || 'غير متوفر' }}/ \){{ env.output_file || 'غير متوفر' }}"
          echo "═══════════════════════════════════════════════════════════"
          echo ""
          echo "ملاحظة: قد يستغرق ظهور الفيديو بشكل كامل 5-60 دقيقة"
          echo "        بعد اكتمال الرفع"