name: Record m3u8 ‚Üí Internet Archive

on:
  workflow_dispatch:
    inputs:
      m3u8_url:
        description: 'ÿ±ÿßÿ®ÿ∑ m3u8'
        required: true
      duration_minutes:
        description: 'ŸÖÿØÿ© ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿ®ÿßŸÑÿØŸÇÿßŸäŸÇ (5‚Äì360 ÿØŸÇŸäŸÇÿ©)'
        required: true
        default: '10'
      title:
        description: 'ÿπŸÜŸàÿßŸÜ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)'
        required: false
        default: 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿ®ÿ´ ŸÖÿ®ÿßÿ¥ÿ±'

jobs:
  record-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: ÿ™ÿ´ÿ®Ÿäÿ™ ÿßŸÑÿ£ÿØŸàÿßÿ™ ÿßŸÑŸÑÿßÿ≤ŸÖÿ©
        run: |
          sudo apt update && sudo apt install -y ffmpeg
          pip install internetarchive

      - name: ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ®ÿ´
        run: |
          MINUTES="${{ inputs.duration_minutes }}"
          DURATION_SECONDS=$(( MINUTES * 60 ))

          OUTPUT="record_$(date +%Y%m%d_%H%M%S).ts"

          ffmpeg -i "${{ inputs.m3u8_url }}" \
            -t "$DURATION_SECONDS" \
            -c copy \
            -y "$OUTPUT" 2> ffmpeg.log || true

          if [ ! -s "$OUTPUT" ]; then
            echo "ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ (ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅ ÿµŸÅÿ±)"
            cat ffmpeg.log
            exit 1
          fi

          echo "output_file=$OUTPUT" >> $GITHUB_ENV
          echo "size_mb=$(du -m "$OUTPUT" | cut -f1)" >> $GITHUB_ENV

      - name: ÿ±ŸÅÿπ ÿ•ŸÑŸâ Internet Archive
        env:
          S3_ACCESS_KEY: ${{ secrets.S3_ACCESS_KEY }}
          S3_SECRET_KEY: ${{ secrets.S3_SECRET_KEY }}
        run: |
          python - <<EOF
          from internetarchive import upload
          import os
          from datetime import date

          identifier = "record-$(date +%Y%m%d-%H%M%S)-${GITHUB_RUN_ID}"
          file_path = "${{ env.output_file }}"

          title = "${{ inputs.title }}" or "ÿ™ÿ≥ÿ¨ŸäŸÑ m3u8 ÿ™ŸÑŸÇÿßÿ¶Ÿä - $(date +%Y-%m-%d)"

          metadata = {
              'title': title,
              'description': f'ÿ™ÿ≥ÿ¨ŸäŸÑ ŸÖÿØÿ© ${{ inputs.duration_minutes }} ÿØŸÇŸäŸÇÿ© ŸÖŸÜ ÿ®ÿ´ m3u8',
              'mediatype': 'movies',
              'collection': 'opensource_movies',
              'subject': 'livestream;m3u8;recording'
          }

          print(f"ÿ®ÿ±ŸÅÿπ ÿ®ŸÖÿπÿ±ŸÅ: {identifier}")

          r = upload(identifier, files=[file_path], metadata=metadata, access_key=os.environ['S3_ACCESS_KEY'], secret_key=os.environ['S3_SECRET_KEY'])

          if r[0].status_code == 200:
              print("ÿ±ŸÅÿπÿ™ ÿßŸÑŸÖÿ™ÿπÿ© ÿ®ŸÜÿ¨ÿßÿ≠ Ÿäÿß ŸàŸÑÿØŸä üí¶")
          else:
              print("ŸÅÿ¥ŸÑ ÿßŸÑÿ±ŸÅÿπ:", r[0].status_code, r[0].text)

          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"identifier={identifier}\\n")
          EOF

      - name: ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ© ÿßŸÑŸÜŸáÿßÿ¶Ÿäÿ©
        if: always()
        run: |
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "ÿßŸÑÿ≠ÿ¨ŸÖ : ${{ env.size_mb }} MB"
          echo "ÿßŸÑŸÖÿØÿ© : ${{ inputs.duration_minutes }} ÿØŸÇŸäŸÇÿ©"
          echo "ÿßŸÑŸÖÿπÿ±ŸÅ : ${{ env.identifier }}"
          echo "ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿπÿ±ÿ∂ : https://archive.org/details/${{ env.identifier }}"
          echo "ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ : https://archive.org/download/${{ env.identifier }}/${{ env.output_file }}"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""
          echo "ŸÖŸÑÿßÿ≠ÿ∏ÿ©: ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑÿßÿ™ ÿßŸÑÿ∑ŸàŸäŸÑÿ© ŸÇÿØ ÿ™Ÿàÿßÿ¨Ÿá ŸÖÿ¥ÿßŸÉŸÑ ŸÅŸä ÿßŸÑÿßÿ≥ÿ™ŸÇÿ±ÿßÿ±"
          echo "ŸàŸÇÿØ Ÿäÿ≥ÿ™ÿ∫ÿ±ŸÇ ÿ∏ŸáŸàÿ± ÿßŸÑŸÅŸäÿØŸäŸà ŸÉÿßŸÖŸÑÿßŸã 10‚Äì60 ÿØŸÇŸäŸÇÿ© ÿ®ÿπÿØ ÿßŸÑÿ±ŸÅÿπ"
