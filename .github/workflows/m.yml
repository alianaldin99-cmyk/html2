name: Record m3u8 → Internet Archive

on:
  workflow_dispatch:
    inputs:
      m3u8_url:
        description: 'رابط m3u8'
        required: true
      duration_minutes:
        description: 'مدة التسجيل بالدقايق (5–360 دقيقة)'
        required: true
        default: '10'
      title:
        description: 'عنوان التسجيل (اختياري)'
        required: false
        default: 'تسجيل بث مباشر'

jobs:
  record-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: تثبيت الأدوات اللازمة
        run: |
          sudo apt update && sudo apt install -y ffmpeg
          pip install internetarchive

      - name: تسجيل البث
        run: |
          MINUTES="${{ inputs.duration_minutes }}"
          DURATION_SECONDS=$(( MINUTES * 60 ))

          OUTPUT="record_$(date +%Y%m%d_%H%M%S).ts"

          ffmpeg -i "${{ inputs.m3u8_url }}" \
            -t "$DURATION_SECONDS" \
            -c copy \
            -y "$OUTPUT" 2> ffmpeg.log || true

          if [ ! -s "$OUTPUT" ]; then
            echo "فشل التسجيل (حجم الملف صفر)"
            cat ffmpeg.log
            exit 1
          fi

          echo "output_file=$OUTPUT" >> $GITHUB_ENV
          echo "size_mb=$(du -m "$OUTPUT" | cut -f1)" >> $GITHUB_ENV

      - name: رفع إلى Internet Archive
        env:
          IA_ACCESS_KEY: ${{ secrets.IA_ACCESS_KEY }}
          IA_SECRET_KEY: ${{ secrets.IA_SECRET_KEY }}
        run: |
          IDENTIFIER="record-$(date +%Y%m%d-%H%M%S)-${GITHUB_RUN_ID}"

          TITLE="${{ inputs.title }}"
          [ -z "$TITLE" ] && TITLE="تسجيل m3u8 تلقائي - $(date +%Y-%m-%d)"

          ia upload "$IDENTIFIER" "${{ env.output_file }}" \
            --metadata="title=$TITLE" \
            --metadata="description=تسجيل مدة ${{ inputs.duration_minutes }} دقيقة من بث m3u8" \
            --metadata="mediatype:movies" \
            --metadata="collection:opensource_movies" \
            --metadata="subject:livestream;m3u8;recording"

          echo "identifier=$IDENTIFIER" >> $GITHUB_ENV

      - name: عرض النتيجة النهائية
        if: always()
        run: |
          echo ""
          echo "══════════════════════════════════════════════════════"
          echo "الحجم : ${{ env.size_mb }} MB"
          echo "المدة : ${{ inputs.duration_minutes }} دقيقة"
          echo "المعرف : ${{ env.identifier }}"
          echo "رابط العرض : https://archive.org/details/${{ env.identifier }}"
          echo "رابط التحميل : https://archive.org/download/${{ env.identifier }}/${{ env.output_file }}"
          echo "══════════════════════════════════════════════════════"
          echo ""
          echo "ملاحظة: التسجيلات الطويلة قد تواجه مشاكل في الاستقرار"
          echo "وقد يستغرق ظهور الفيديو كاملاً 10–60 دقيقة بعد الرفع"
