name: Record m3u8 â†’ Telegram

on:
  workflow_dispatch:
    inputs:
      m3u8_url:
        description: 'Ø±Ø§Ø¨Ø· m3u8'
        required: true
      duration_minutes:
        description: 'Ù…Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ (5â€“360)'
        required: true
        default: '10'
      title:
        description: 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)'
        required: false
        default: 'ØªØ³Ø¬ÙŠÙ„ Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±'

jobs:
  record-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: ØªØ«Ø¨ÙŠØª ffmpeg
        run: |
          sudo apt update && sudo apt install -y ffmpeg

      - name: ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø« Ø¨Ø¯ÙˆÙ† ØªØ±Ù…ÙŠØ²
        run: |
          MINUTES="${{ inputs.duration_minutes }}"
          DURATION=$(( MINUTES * 60 ))

          TITLE="${{ inputs.title }}"
          OUTPUT_FILE="recorded_stream.mp4"

          echo "ğŸ“¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø« Ù„Ù…Ø¯Ø© $MINUTES Ø¯Ù‚ÙŠÙ‚Ø©..."
          # -c copy â†’ Ø¨Ø¯ÙˆÙ† encodingØŒ ÙŠØ£Ø®Ø° Ø§Ù„Ø¨Ø« ÙƒÙ…Ø§ Ù‡Ùˆ
          ffmpeg -y -i "${{ inputs.m3u8_url }}" -c copy -t "$DURATION" "$OUTPUT_FILE"

          echo "âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„: $OUTPUT_FILE"
          ls -lh "$OUTPUT_FILE"

      - name: Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¥Ù„Ù‰ Ù‚Ù†Ø§Ø© Telegram
        run: |
          echo "ğŸ“¤ Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¥Ù„Ù‰ Ù‚Ù†Ø§Ø© Telegram..."
          # Ø§Ø³ØªØ®Ø¯Ù… -F Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ùƒ multipart/form-data
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendVideo" \
            -F chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -F video=@"recorded_stream.mp4" \
            -F caption="$TITLE"
          echo "âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­"

      - name: Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø« ÙˆØ­ÙØ¸Ù‡ Ø¨Ø¯ÙˆÙ† ØªØ±Ù…ÙŠØ²"
          echo "Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ${{ inputs.title }}"
          echo "Ù…Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ${{ inputs.duration_minutes }} Ø¯Ù‚ÙŠÙ‚Ø©"
          echo "Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø±ÙÙˆØ¹ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ù†Ø§Ø©"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
